# MQTT 协议说明

原文链接：[MQTT V3.1 Protocol Specification](http://public.dhe.ibm.com/software/dw/webservices/ws-mqtt/mqtt-v3r1.html#flows)

## 摘要

MQTT（`MQ Telemetry Transport`）是一个基于订阅的轻量级消息协议（设计初衷：开放、简单、轻量级、易实现）。而这些特质使得它被使用于一些受约束的环景。例如：

* 网络低带宽、网络不可靠的环境。
* 嵌入于一些受限制的设备（处理器性能较差、内存资源过少）

协议的特点：

* 这种订阅消息模式提供了一对多的消息分配、以及应用的解耦性
* 消息传输过程中的载体都是不可预知的
* 基于TCP/IP
* 提供了三种消息传递的品质
	* `"At most once"`
	* `"At lease once"`
	* `Exactly once`
* 一个小型的传输头部信息、协议交换的信息被压缩到最小、从而降低网络传输流量
* 有一个机制、可以在未知原因导致的断开连接时，广播告诉其他人（遗嘱特色）

## 版权声明

## 目录


## 介绍

协议说明分为三大段落

* 通用于所有数据报类型的消息格式
* 各个数据包类型的特殊详情
* 数据包如何在客户端与服务端进行传输

更多详情请见附录（`如何更通用的使用话题`）

### 演进

介绍 `MQTT V3` 与 `MQTT V3.1` 之间的变化

* 用户的登录名与密码现在已经可以通过连接的数据包进行发送传输。
* 解决了数据包返回code码的加密问题
* 当客户端没有接收到用户认证的通知，那么本应该执行MQTT的命令将不会被执行。
* 字符串在MQTT的可支持`UTF-8`（之前版本支持`US_ASCII`）

协议的版本号会被传递在连接的数据报中，在这次修订中并没有被修正，依然为`"3"`。已存在的MQTT（`V3`）服务器安装启动需要接收支持本地修订的客户端连接，只要当前遵守剩余长度的领域，因此忽略了本次额外的加密信息。

## 消息格式

MQTT的每一个命令消息都包含了一个固定的头信息。一些消息也需要一个可变的头部消息和载体。每个消息头部的格式描述格式如下：

### 固定的头部格式

每一个MQTT的命令消息都包含了一个固定的头部信息，如下表所示：

![](recource/MQTT_Fixed_Header.png)

* Byte1
	* 包含了消息类型、其他标志位（`DUP、QoS Level、RETAIN`）
* Byte2
	* 包含了剩余长度域（至少一个字节）



